{% extends 'base.html' %}
{% block content %}
<div class="table-container">
  <br>
  <h1 class="title">{{ title2|upper }}</h1>

  <!-- CSRF oculto para JS -->
  <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

  <form method="get">
    <input type="text" name="q" value="{{ request.GET.q }}" placeholder="Buscar por cliente, fecha o mÃ©todo de pago">
    <button type="submit">Buscar</button>
  </form>

  <table class="styled-table">
    <thead>
      <tr>
        <th>Cliente</th>
        <th>MÃ©todo de Pago</th>
        <th>Fecha EmisiÃ³n</th>
        <th>Subtotal</th>
        <th>IVA</th>
        <th>Total</th>
        <th>Estado</th>
        <th>Acciones</th>
      </tr>
    </thead>

    <tbody>
      {% for item in invoices %}
      <tr id="invoice-row-{{ item.id }}">
        <td>{{ item.customer.get_full_name }}</td>
        <td>{{ item.get_payment_method_display }}</td>
        <td>{{ item.issue_date|date:"d/m/Y H:i" }}</td>
        <td>${{ item.subtotal }}</td>
        <td>${{ item.iva }}</td>
        <td><strong>${{ item.total }}</strong></td>
        <td class="text-center">
          {% if item.state %}
          <span class="badge bg-success">Activo</span>
          {% else %}
          <span class="badge bg-danger">Anulado</span>
          {% endif %}
        </td>
        <td class="text-center">
          <button type="button" class="btn btn-sm btn-outline-primary view-detail" data-id="{{ item.id }}">ğŸ”
            Ver</button>
          <a href="{% url 'commerce:invoice_print' item.id %}" target="_blank" class="btn btn-sm btn-info"
            title="Imprimir">ğŸ–¨ï¸</a>
          <a href="{% url 'commerce:invoice_update' item.id %}" class="btn btn-sm btn-warning" title="Editar">âœï¸</a>
          <button type="button" class="btn btn-sm btn-danger btn-delete" data-id="{{ item.id }}">ğŸ—‘ï¸ Eliminar</button>
          {% if item.state %}
          <button type="button" class="btn btn-sm btn-secondary btn-annul" data-id="{{ item.id }}">ğŸš« Anular</button>
          {% endif %}
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="10" style="text-align:center;">No hay facturas registradas.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <div class="form-group mt-3">
    <a class="btn blue" href="{% url 'commerce:invoice_create' %}">â• Nueva Factura</a>
  </div>
</div>

<!-- ================= MODAL DETALLE DE FACTURA ================= -->
<div class="modal fade" id="invoiceModal" tabindex="-1" aria-labelledby="invoiceModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content" id="modalContent"></div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const modal = new bootstrap.Modal(document.getElementById('invoiceModal'));
    const modalContent = document.getElementById('modalContent');

    // CSRF token desde el input oculto
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    const baseDetailUrl = "/commerce/invoice/detail/";
    const deleteUrlBase = "{% url 'commerce:invoice_delete' 0 %}".replace('0', ''); 
    const annulUrlBase = "{% url 'commerce:invoice_annul' 0 %}".replace('0', '');

    // Ver detalle
    document.querySelectorAll('.view-detail').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.dataset.id;
         fetch(`${baseDetailUrl}${id}`)
          .then(res => res.json())
          .then(data => {
            modalContent.innerHTML = data.html;
            modal.show();
          })
          .catch(() => alert('No se pudo cargar el detalle de la factura.'));
      });
    });

    // Eliminar factura
    document.querySelectorAll('.btn-delete').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.dataset.id;
        if (!confirm(`Â¿Seguro que desea eliminar la factura NÂ° ${id}?`)) return;

        const url = `{% url 'commerce:invoice_delete' 0 %}`.replace('0', id);

        fetch(url, {
          method: 'POST',
          headers: {
            'X-CSRFToken': csrftoken,
            'X-Requested-With': 'XMLHttpRequest'
          }
        })
          .then(res => {
            if (!res.ok) throw new Error(`Error HTTP ${res.status}`);
            return res.json();
          })
          .then(data => {
            if (data.msg) {
              alert(data.msg);
              document.getElementById(`invoice-row-${id}`).remove();
            } else if (data.error) {
              alert(data.error);
            }
          })
          .catch(err => {
            console.error("Error al eliminar la factura:", err);
            alert('Error al eliminar la factura.');
          });
      });
    });

    // Anular factura
    document.querySelectorAll('.btn-annul').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.dataset.id;
        if (!confirm(`Â¿Seguro que desea anular la factura NÂ° ${id}?`)) return;

        fetch(`${annulUrlBase}${id}/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': csrftoken,
            'X-Requested-With': 'XMLHttpRequest'
          }
        })
          .then(res => res.json())
          .then(data => {
            if (data.msg) location.reload();
            else if (data.error) alert(data.error);
          })
          .catch(() => alert('Error al anular la factura.'));
      });
    });
  });
</script>
{% endblock content %}