{% extends 'base.html' %}
{% block content %}
<div class="table-container">
  <br>
  <h1 class="title">{{ title2|upper }}</h1>

  <form method="get">
    <input type="text" name="q" value="{{ request.GET.q }}" placeholder="Buscar por cliente, fecha o m√©todo de pago">
    <button type="submit">Buscar</button>
  </form>

  <table class="styled-table">
    <thead>
      <tr>
        <th>Cliente</th>
        <th>M√©todo de Pago</th>
        <th>Fecha Emisi√≥n</th>
        <th>Subtotal</th>
        <th>IVA</th>
        <th>Total</th>
        <th>Estado</th>
        <th>Acciones</th>
      </tr>
    </thead>

    <tbody>
      {% for item in invoices %}
      <tr>
        <td>{{ item.customer.get_full_name }}</td>
        <td>{{ item.get_payment_method_display }}</td>
        <td>{{ item.issue_date|date:"d/m/Y H:i" }}</td>
        <td>${{ item.subtotal }}</td>
        <td>${{ item.iva }}</td>
        <td><strong>${{ item.total }}</strong></td>
       <td class="text-center">
          {% if item.state %}
            <span class="badge bg-success">Activo</span>
          {% else %}
            <span class="badge bg-danger">Anulado</span>
          {% endif %}
        </td>
        <td class="text-center">
          <!-- Bot√≥n que abre el modal -->
          <button type="button" class="btn btn-sm btn-outline-primary view-detail" data-id="{{ item.id }}">
            üîé Ver
          </button>
          <a href="{% url 'commerce:invoice_update' item.id %}" title="Editar">‚úèÔ∏è</a>
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="10" style="text-align:center;">No hay facturas registradas.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <div class="form-group mt-3">
    <a class="btn blue" href="{% url 'commerce:invoice_create' %}">‚ûï Nueva Factura</a>
  </div>
</div>

<!-- ================= MODAL DETALLE DE FACTURA ================= -->
<div class="modal fade" id="invoiceModal" tabindex="-1" aria-labelledby="invoiceModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content" id="modalContent">
      <!-- El contenido del detalle se cargar√° din√°micamente aqu√≠ -->
    </div>
  </div>
</div>

<!-- ================= SCRIPT PRINCIPAL ================= -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  const modal = new bootstrap.Modal(document.getElementById('invoiceModal'));
  const modalContent = document.getElementById('modalContent');
  const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;

  // URL base del detalle
  const baseDetailUrl = "{% url 'commerce:invoice_detail' 0 %}".replace('0/', '');
  const deleteUrlBase = "{% url 'commerce:invoice_delete' 0 %}".replace('0/', '');
  const annulUrlBase = "{% url 'commerce:invoice_annul' 0 %}".replace('0/', '');

  // --- Abrir modal y cargar contenido ---
  document.querySelectorAll('.view-detail').forEach(btn => {
    btn.addEventListener('click', () => {
      const id = btn.dataset.id;
      const url = `${baseDetailUrl}${id}/`;

      fetch(url)
        .then(res => res.json())
        .then(data => {
          modalContent.innerHTML = data.html;
          modal.show();
        })
        .catch(err => {
          console.error('Error al cargar el detalle:', err);
          alert('No se pudo cargar el detalle de la factura.');
        });
    });
  });

  // --- Delegaci√≥n de eventos para botones din√°micos ---
  document.addEventListener('click', (e) => {
    const btn = e.target.closest('#btnDelete, #btnAnnul');
    if (!btn) return;

    const id = btn.dataset.id;
    const isDelete = btn.id === 'btnDelete';
    const action = isDelete ? 'eliminar' : 'anular';
    const url = isDelete ? deleteUrlBase : annulUrlBase;

    if (!confirm(`¬øSeguro que desea ${action} la factura N¬∞ ${id}?`)) return;

    fetch(`${url}${id}/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrftoken,
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
    .then(res => res.json())
    .then(data => {
      alert(data.msg);
      modal.hide();
      location.reload();
    })
    .catch(err => {
      console.error('Error en acci√≥n:', err);
      alert('Ocurri√≥ un error al procesar la solicitud.');
    });
  });
});
</script>
{% endblock content %}
